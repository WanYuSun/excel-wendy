# Excel 数据处理工具 - 月结功能说明

## 🆕 新增功能

### 月结数据处理模式

- **目标**：专门处理月结数据，数据量更大，sheet 数量更多
- **优化**：使用并发处理和高性能算法，适应大数据量场景
- **兼容**：完全兼容原有周结处理逻辑

## 📁 目录结构

```
excel/
├── excel_operator.py           # 主程序（支持周结/月结选择）
├── handlers/
│   ├── week/                   # 周结处理器
│   │   ├── guangdiantong.py
│   │   ├── guangdiantong_v2.py
│   │   ├── kuaishou.py
│   │   └── toutiao.py
│   └── month/                  # 🆕月结处理器
│       ├── guangdiantong.py    # 广点通月结处理
│       ├── guangdiantong_v2.py # 大端口月结处理
│       ├── kuaishou.py         # 快手月结处理
│       └── toutiao.py          # 头条月结处理
├── common.py
├── log.py
├── select_excels.py
└── union_sheets.py
```

## 🚀 使用方法

### 1. 启动程序

```bash
python excel_operator.py
```

### 2. 选择处理类型

程序启动后会显示选择菜单：

```
请选择数据处理类型:
1. 周结数据处理 (数据量较小，处理速度快)
2. 月结数据处理 (数据量较大，使用并发优化)
3. 退出程序

请输入选项编号 (1/2/3):
```

### 3. 数据处理差异

#### 周结模式 (选择 1)

- **数据库文件**：`excel_week.db`
- **输出文件前缀**：`output_入口名.xlsx`
- **处理方式**：标准处理，适合小到中等数据量
- **线程数**：默认 CPU 核心数

#### 月结模式 (选择 2)

- **数据库文件**：`excel_month.db`
- **输出文件前缀**：`month_入口名.xlsx`
- **处理方式**：高并发处理，适合大数据量
- **线程数**：8-12 个线程（根据处理器优化）

## 🔧 月结模式特性

### 1. 性能优化

- **并发 Sheet 处理**：使用`union_sheets_concurrent`并发处理多个 Excel sheets
- **高线程数**：月结模式使用更多线程（8-12 个）处理大数据量
- **内存优化**：流式处理，避免内存积累

### 2. 数据处理增强

- **智能文件合并**：支持多个同类文件自动合并
- **批量插入优化**：大数据量使用批量 INSERT 策略
- **索引优化**：自动创建索引提升查询性能

### 3. 错误处理

- **任务级隔离**：单个文件处理失败不影响其他文件
- **并发安全**：多线程环境下的安全处理
- **资源清理**：自动清理临时表和资源

## 📊 支持的数据源

### 广点通月结

- **特点**：支持更多字段维度
- **新增字段**：主体名称、客户名称、业务线
- **优化**：按消耗金额排序输出

### 快手月结

- **特点**：支持多个消耗文件合并
- **处理方式**：用户可选择单文件或多文件合并
- **数据关联**：充值和消耗数据智能关联

### 头条月结

- **特点**：处理三类文件（消耗、充值、共享钱包流水）
- **增强功能**：共享钱包转入转出分别统计
- **数据完整性**：确保所有维度数据完整

### 大端口月结

- **特点**：专门优化大数据量处理
- **高并发**：使用 12 个线程处理
- **字段扩展**：支持更多业务字段

## 💡 最佳实践

### 1. 数据准备

- **文件命名**：确保 Excel 文件按标准命名规则
- **数据格式**：所有 sheet 保持相同的列结构
- **文件大小**：月结模式建议单文件不超过 500MB

### 2. 性能优化

- **硬件要求**：月结模式建议 8GB+内存，多核 CPU
- **磁盘空间**：确保有足够的临时存储空间
- **网络环境**：避免在网络驱动器上处理大文件

### 3. 错误处理

- **日志查看**：关注彩色日志输出，及时发现问题
- **跳过策略**：遇到问题文件可选择跳过继续处理
- **数据验证**：处理完成后验证输出文件的数据完整性

## 🔍 故障排除

### 常见问题

1. **内存不足**

   - 减少并发线程数
   - 分批处理大文件
   - 关闭其他占用内存的程序

2. **文件读取失败**

   - 检查文件是否被其他程序占用
   - 验证文件路径是否正确
   - 确认文件格式为.xlsx

3. **数据库连接问题**
   - 检查磁盘空间
   - 确认有写入权限
   - 重启程序重新初始化连接

### 日志分析

- **绿色 ✅**：操作成功
- **红色 ❌**：错误需要关注
- **黄色 ⚠️**：警告信息
- **蓝色 ℹ️**：普通信息

## 📈 性能对比

| 模式 | 数据量  | 处理时间  | 内存使用 | 并发度 |
| ---- | ------- | --------- | -------- | ------ |
| 周结 | < 100MB | 1-5 分钟  | 低       | 标准   |
| 月结 | > 500MB | 5-20 分钟 | 中等     | 高     |

## 🔮 未来规划

- **季度结算**：计划添加季度数据处理模式
- **年度汇总**：支持年度数据汇总分析
- **可视化**：增加数据可视化输出功能
- **API 接口**：提供 REST API 接口供其他系统调用
